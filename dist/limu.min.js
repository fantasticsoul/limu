!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var r,t,n,a,o=function(){return(o=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)};function i(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;var n=Array(e),a=0;for(r=0;r<t;r++)for(var o=arguments[r],i=0,f=o.length;i<f;i++,a++)n[a]=o[i];return n}var f={Map:"Map",Set:"Set",Array:"Array"},l="[object Object]",u="[object Map]",c="[object Set]",p="[object Array]",s="[object Function]",d=((r={})[u]=f.Map,r[c]=f.Set,r[p]=f.Array,r[l]="Object",r),y=["length","slice","concat","find","findIndex","filter","flat","flatMap","includes","indexOf","every","some","constructor","join","keys","lastIndexOf","reduce","reduceRight","values","entries","valueOf"],v=i(["entries","keys","values","has"],["size"]),h=i(["entries","has","keys","values"],["size"]),M=((t={})[f.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[f.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[f.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),m=((n={})[f.Map]=["clear","delete","set"],n[f.Set]=["add","clear","delete"],n[f.Array]=["concat","copyWithin","fill","flat","flatMap","pop","push","reverse","shift","unshift","splice"],n),b=((a={})[f.Map]=["forEach","get"],a[f.Set]=["forEach"],a[f.Array]=["forEach","map"],a),x=Object.prototype.toString;function _(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function g(e){return x.call(e)===l}function w(e){return x.call(e)===u}function S(e){return x.call(e)===c}function O(e){return x.call(e)===s}function E(e){var r=x.call(e);return![l,p,u,c,s].includes(r)}function j(e){return/^[0-9]*$/.test(e)}function A(e){return"symbol"==typeof e}var k=Symbol("verKey"),I=Symbol("metas"),D=Symbol("finishHandler"),P={},T={value:0};function V(e,r,t){var n=[r],a=B(e,t);return a&&a.level>0?i(a.keyPath,[r]):n}function B(e,r){var t=L(e);return t?t[r]:null}function z(e,r){return e?B(e.__proto__,r):null}function L(e){return e?e[I]:null}function N(e,r){var t=e.self;if(Array.isArray(t))return e.proxyItems||t.slice();if(g(t))return o({},t);if(w(t))return e.proxyItems||r||new Map(t);if(S(t))return e.proxyItems||r||new Set(t);throw new Error("data "+t+" try trigger getCopy, its type is "+typeof e)}function W(e){return Array.isArray(e)?e.slice():e&&g(e)?o({},e):w(e)?new Map(e):S(e)?new Set(e):e}function F(e,r,t){var n=L(e);n&&(n[t]=r)}function R(e,r){var t=B(e,r);return t?t.level+1:1}function C(e){return!!e[k]}function H(e){var r,t=(r=e,x.call(r));return d[t]}function J(e){var r,t=e.parentMeta,n=e.parentType,a=e.idx,o=e.copy;if(t){var i=t.copy;i||(i=N(t),t.copy=i);var f=!1;"Map"===n?(i.set(a,o),f=!0):"Object"===n?i[a]=o:"Array"===n?(i[a]=o,f=!0):"Set"===n&&(f=!0);var l=t.proxyItems;f&&l&&(l.__modified=!0,l.__parent=null===(r=t.parentMeta)||void 0===r?void 0:r.copy,l.__dataIndex=t.idx)}}function K(e,r,t){if(null==e?void 0:e.rootMeta){e.rootMeta.modified=!0;var n=B(r,t);n&&J(n)}}function $(e,r,t,n,a){var o=r.delete.bind(r),i=r.clear.bind(r);if(r.add=function(){_()},r.set=function(){_()},r.delete=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return K(t,n,a),o.apply(void 0,e)},r.clear=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return K(t,n,a),i.apply(void 0,e)},"Set"===e){var f=r.add.bind(r);r.add=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return K(t,n,a),f.apply(void 0,e)}}if("Map"===e){var l=r.set.bind(r);r.set=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return K(t,n,a),l.apply(void 0,e)}}}var q=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],G=["clear","delete","set"],Q=["add","clear","delete"];function U(e,r,t){var n=r.op,a=r.key,o=r.value,i=r.metaVer,l=r.calledBy,u=r.parentType,c=B(e,i),p=o;if(t&&(p=function(e,r){var t=z(e,r);if(!t)return e;var n=t.copy;return n||(n=N(t),t.copy=n),n}(o,i)),c){var s=c.self,d=c.rootMeta,b=c.copy;if(function(e,r){if(e===f.Array){if(y.includes(r))return!1;if(j(r))return!1}return!(e===f.Map&&v.includes(r)||e===f.Set&&h.includes(r)||A(r))}(u,n)){if(b&&!["Map","Set"].includes(u)||(b=N(c,b),c.copy=b),!E(p)){var x=B(o,i);x&&x.parentMeta&&x.parentMeta.level!==c.level&&(x.parent=c.self,x.level=c.level+1,x.key=a,x.keyPath=V(x.parent,a,i))}!function(e){var r=e.calledBy,t=e.parentDataNodeMeta,n=e.op,a=e.parentType;(["deleteProperty","set"].includes(r)||"get"===r&&("Set"===a&&Q.includes(n)||"Array"===a&&q.includes(n)||"Map"===a&&G.includes(n)))&&J(t)}({calledBy:l,parentDataNodeMeta:c,op:n,parentType:u});var _=c.parentMeta;if(_){var g={key:c.key,parentType:c.parentType,value:b,metaVer:i,calledBy:l};U(_.self,g,!1)}}var w=function(){c.modified=!0,d&&(d.modified=!0)};if((M[u]||[]).includes(n)&&O(o))return m[u].includes(n)&&w(),"slice"===n?s.slice:b?u===f.Set||u===f.Map?b[n].bind(b):["map","sort"].includes(n)?b[n].bind(c.proxyVal):b[n].bind(c.proxyItems):s[n].bind(s);if(!b)return p;if(t)if("del"===n)delete b[a];else{if("toJSON"===n&&!o)return;b[a]=p}["set","deleteProperty"].includes(l)&&w()}else e[a]=p}function X(e,r,t){if(void 0===t&&(t=!1),function(e){return!E(e)}(e)){var n=e[I];n||(!function(e,r){var t=Object.create(null);Object.setPrototypeOf(t,r),Object.setPrototypeOf(e,t),e.__proto__[I]={}}(e,function(e){return Object.getPrototypeOf(e)?Object.getPrototypeOf(e):Object.prototype}(e)),n=e[I]);var a=P[r];return a||(a=P[r]=[]),void a.push(n)}if(t)throw new Error("type can only be object(except null) or array")}var Y=["length","constructor","asymmetricMatch","nodeType","size"],Z=[f.Array,f.Set,f.Map],ee=[f.Set,f.Map,"Object"];function re(){var e,r,t,n,a=(T.value+=1,e=T.value,r=!1,t=null,n={get:function(r,t){if(t===k)return e;var a=r[t];if("__proto__"===t||t===D)return a;if(A(t))return O(a)?a.bind(r):a;var o=H(r),i=B(r,e);if(i&&Z.includes(o)&&Y.includes(t))return i.copy?i.copy[t]:i.self[t];if(i&&!ee.includes(o)){var l=i.self,u=i.copy,c=l[t];if(u&&(a=u[t]),c!==a)return a}var p=function(a,i,l){var u,c;if(void 0===l&&(l=-1),a&&!E(a)){var s=B(a,e);if(O(a)){if(function(e,r){return"Array"===e||(b[e]||[]).includes(r)}(o,t)){if(!(s=B(r,e)))throw new Error("[[ createMeta ]]: oops, meta should not be null");if(!s.proxyItems){var d=[];if(o===f.Set){var y=new Set;r.forEach((function(e){return y.add(p(e,W(e)))})),$("Set",y,s,r,e),d=y}else if(o===f.Map){var v=new Map;r.forEach((function(e,r){return v.set(r,p(e,W(e),r))})),$("Map",v,s,r,e),d=v}else if(o===f.Array){var h=[];r.forEach((function(e,r){return h.push(p(e,W(e),r))})),d=h}s.proxyItems=d;var M=null===(c=null===(u=s.rootMeta)||void 0===u?void 0:u.proxyItemsMgr)||void 0===c?void 0:c[o];M&&M.push(d)}}return a}if(X(a,e),!s){s={rootMeta:null,parentMeta:null,parent:r,parentType:o,self:a,key:t,idx:l,keyPath:V(r,l,e),level:R(r,e),proxyVal:new Proxy(a,n),copy:i,modified:!1,proxyItems:null,proxyItemsMgr:null,finishDraft:_,ver:e};var m=B(r,e);m&&(s.parentMeta=m,s.rootMeta=m.rootMeta),F(a,s,e)}return s.proxyVal}return a};return a=p(a,null,t),o===f.Array&&j(t)?a:f[o]?U(r,{parentType:o,op:t,key:t,value:a,metaVer:e,calledBy:"get"},!0):a},set:function(r,t,n){return U(r,{key:t,value:n,metaVer:e,calledBy:"set"},!0),B(r,e),!0},deleteProperty:function(r,t){return U(r,{op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"},!0),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(o){if(r)throw new Error("can not call new Limu().createDraft twice");var i=o;r=!0,C(o)&&(i=z(o,o[k]).self),X(i,e,!0);var f=B(i,e);f||((f={rootMeta:null,parent:null,parentMeta:null,parentType:H(i),self:i,copy:null,modified:!1,key:"",keyPath:[],idx:-1,level:0,proxyVal:null,proxyItems:null,proxyItemsMgr:{Map:[],Set:[],Array:[]},finishDraft:a.finishDraft,ver:e}).rootMeta=f,F(i,f,e));var l=Proxy.revocable(i,n),u=l.proxy,c=l.revoke;return f.proxyVal=u,t=c,u},finishDraft:function(r){if(e!==r[k])throw new Error("oops, the input draft does not match finishDraft handler");var n=z(r,e);if(!n)throw new Error("oops, rootMeta should not be null!");var a=n.self;if(n.copy&&n.modified){a=n.copy;var o=n.proxyItemsMgr.Map,i=null;o.forEach((function(r){if(r.__modified){var t=new Map;i=t,r.forEach((function(r,n){var a=B(r,e);if(a){var o=a.modified?a.copy:a.self;t.set(n,o)}})),r.__parent&&(r.__parent[r.__dataIndex]=t)}})),"Map"===n.parentType&&(a=i||a);var f=n.proxyItemsMgr.Set,l=null;f.forEach((function(r){if(r.__modified){var t=Array.from(r);l=t,t.forEach((function(r,n){var a=B(r,e);a&&(t[n]=a.modified?a.copy:a.self)})),r.__parent&&(r.__parent[r.__dataIndex]=new Set(t))}})),"Set"===n.parentType&&(a=l?new Set(l):a),n.proxyItemsMgr.Array.forEach((function(r){r.__modified&&r.forEach((function(t,n){var a=B(t,e);a&&!a.modified&&(r[n]=a.self)}))}))}return t&&t(),function(e){P[e].forEach((function(r){return delete r[e]}))}(e),a}});return a}var te=function(){var e=re();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function ne(e){return(new te).createDraft(e)}function ae(e){var r=z(e,e[k]),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("opps, not an Limu draft!");return t(e)}function oe(e){if("function"!=typeof e)throw new Error("produce callback is not a function");if("AsyncFunction"===(r=e).constructor.name||"function"==typeof r.then)throw new Error("produce callback can not be a promise function");var r}function ie(e,r,t){void 0===t&&(t=!0),t&&oe(r);var n=ne(e);return r(n),ae(n)}var fe=C,le=function(e,r){return r?ie(e,r):(oe(e),function(r){return ie(r,e,!1)})};e.Limu=te,e.createDraft=ne,e.finishDraft=ae,e.getDraftMeta=function(e){return z(e,e[k])},e.isDraft=fe,e.produce=le,Object.defineProperty(e,"__esModule",{value:!0})}));
