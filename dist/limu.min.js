!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var r,t,n,a,o=function(){return(o=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)};function i(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;var n=Array(e),a=0;for(r=0;r<t;r++)for(var o=arguments[r],i=0,l=o.length;i<l;i++,a++)n[a]=o[i];return n}var l={Map:"Map",Set:"Set",Array:"Array"},f="[object Object]",u="[object Map]",c="[object Set]",p="[object Array]",s="[object Function]",y=((r={})[u]=l.Map,r[c]=l.Set,r[p]=l.Array,r[f]="Object",r),d=["length","slice","concat","find","findIndex","filter","flat","flatMap","includes","indexOf","every","some","constructor","join","keys","lastIndexOf","reduce","reduceRight","values","entries","valueOf"],v=i(["entries","keys","values","has"],["size"]),h=i(["entries","has","keys","values"],["size"]),M=((t={})[l.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[l.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[l.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),m=((n={})[l.Map]=["clear","delete","set"],n[l.Set]=["add","clear","delete"],n[l.Array]=["copyWithin","fill","pop","push","reverse","shift","unshift","splice"],n),b=((a={})[l.Map]=["forEach","get"],a[l.Set]=["forEach"],a[l.Array]=["forEach","map"],a),x=Object.prototype.toString;function g(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function _(e){return x.call(e)===f}function w(e){return x.call(e)===u}function S(e){return x.call(e)===c}function O(e){return x.call(e)===s}function A(e){var r=x.call(e);return![f,p,u,c,s].includes(r)}function E(e){return/^[0-9]*$/.test(e)}function k(e){return"symbol"==typeof e}var j=Symbol("verKey"),I=Symbol("metas"),D=Symbol("finishHandler"),T=Symbol("isModifiedKey"),P={},V={value:0};function B(e,r,t){var n=[r],a=z(e,t);return a&&a.level>0?i(a.keyPath,[r]):n}function z(e,r){var t=N(e);return t?t[r]:null}function L(e,r){return e?z(e.__proto__,r):null}function N(e){return e?e[I]:null}function W(e,r){var t=e.self;if(Array.isArray(t))return e.proxyItems||t.slice();if(_(t))return o({},t);if(w(t))return e.proxyItems||r||new Map(t);if(S(t))return e.proxyItems||r||new Set(t);throw new Error("data "+t+" try trigger getCopy, its type is "+typeof e)}function F(e){return Array.isArray(e)?e.slice():e&&_(e)?o({},e):w(e)?new Map(e):S(e)?new Set(e):e}function K(e,r,t){var n=N(e);n&&(n[t]=r)}function R(e,r){var t=z(e,r);return t?t.level+1:1}function C(e){return!!e[j]}function H(e){var r,t=(r=e,x.call(r));return y[t]}function J(e,r,t){var n,a=e.parentMeta,o=e.parentType,i=e.selfType,l=e.idx,f=e.copy;if("set"===r&&E(t)&&"Array"===i){var u=e.proxyItems;u&&(u[T]=!0)}if(a){var c=a.copy;c||(c=W(a),a.copy=c);var p=!1;"Map"===o?(c.set(l,f),p=!0):"Object"===o?c[l]=f:"Array"===o?(c[l]=f,p=!0):"Set"===o&&(p=!0);var s=a.proxyItems;p&&s&&(s[T]=!0,s.__parent=null===(n=a.parentMeta)||void 0===n?void 0:n.copy,s.__dataIndex=a.idx)}}function $(e,r,t){if(null==e?void 0:e.rootMeta){e.rootMeta.modified=!0;var n=z(r,t);n&&J(n)}}function q(e,r,t,n,a){var o=r.delete.bind(r),i=r.clear.bind(r);if(r.add=function(){g()},r.set=function(){g()},r.delete=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return $(t,n,a),o.apply(void 0,e)},r.clear=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return $(t,n,a),i.apply(void 0,e)},"Set"===e){var l=r.add.bind(r);r.add=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return $(t,n,a),l.apply(void 0,e)}}if("Map"===e){var f=r.set.bind(r);r.set=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return $(t,n,a),f.apply(void 0,e)}}}var G=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],Q=["clear","delete","set"],U=["add","clear","delete"];function X(e,r,t){var n=r.op,a=r.key,o=r.value,i=r.metaVer,f=r.calledBy,u=r.parentType,c=z(e,i),p=o;if(t&&(p=function(e,r){var t=L(e,r);if(!t)return e;var n=t.copy;return n||(n=W(t),t.copy=n),n}(o,i)),c){var s=c.self,y=c.rootMeta,b=c.copy;if(function(e,r){if(e===l.Array){if(d.includes(r))return!1;if(E(r))return!1}return!(e===l.Map&&v.includes(r)||e===l.Set&&h.includes(r)||k(r))}(u,n)){if(b&&!["Map","Set"].includes(u)||(b=W(c,b),c.copy=b),!A(p)){var x=z(o,i);x&&x.parentMeta&&x.parentMeta.level!==c.level&&(x.parent=c.self,x.level=c.level+1,x.key=a,x.keyPath=B(x.parent,a,i))}!function(e){var r=e.calledBy,t=e.parentDataNodeMeta,n=e.op,a=e.parentType,o=e.key;(["deleteProperty","set"].includes(r)||"get"===r&&("Set"===a&&U.includes(n)||"Array"===a&&G.includes(n)||"Map"===a&&Q.includes(n)))&&J(t,r,o)}({calledBy:f,parentDataNodeMeta:c,op:n,key:a,parentType:u});var g=c.parentMeta;if(g){var _={key:c.key,parentType:c.parentType,value:b,metaVer:i,calledBy:f};X(g.self,_,!1)}}var w=function(){c.modified=!0,y&&(y.modified=!0)};if((M[u]||[]).includes(n)&&O(o))return m[u].includes(n)&&w(),"slice"===n?s.slice:b?u===l.Set||u===l.Map?b[n].bind(b):["map","sort"].includes(n)?b[n].bind(c.proxyVal):b[n].bind(c.proxyItems):s[n].bind(s);if(!b)return p;if(t)if("del"===n)delete b[a];else{if("toJSON"===n&&!o)return;b[a]=p}["set","deleteProperty"].includes(f)&&w()}else e[a]=p}function Y(e,r,t){if(void 0===t&&(t=!1),function(e){return!A(e)}(e)){var n=e[I];n||(!function(e,r){var t=Object.create(null);Object.setPrototypeOf(t,r),Object.setPrototypeOf(e,t),e.__proto__[I]={}}(e,function(e){return Object.getPrototypeOf(e)?Object.getPrototypeOf(e):Object.prototype}(e)),n=e[I]);var a=P[r];return a||(a=P[r]=[]),void a.push(n)}if(t)throw new Error("type can only be object(except null) or array")}var Z=["length","constructor","asymmetricMatch","nodeType","size"],ee=[l.Array,l.Set,l.Map],re=[l.Set,l.Map,"Object"];function te(){var e,r,t,n,a=(V.value+=1,e=V.value,r=!1,t=null,n={get:function(r,t){if(t===j)return e;var a=r[t];if("__proto__"===t||t===D||t===T)return a;if(k(t))return O(a)?a.bind(r):a;var o=H(r),i=z(r,e);if(i&&ee.includes(o)&&Z.includes(t))return i.copy?i.copy[t]:i.self[t];if(i){var f=i.self,u=i.copy,c=f[t],p=!1;if(re.includes(o)||(p=!0),p&&(u&&(a=u[t]),c!==a))return a}var s=function(a,i,f){var u,c;if(void 0===f&&(f=-1),a&&!A(a)){var p=z(a,e);if(O(a)){if(function(e,r){return"Array"===e||(b[e]||[]).includes(r)}(o,t)){if(!(p=z(r,e)))throw new Error("[[ createMeta ]]: oops, meta should not be null");if(!p.proxyItems){var y=[];if(o===l.Set){var d=new Set;r.forEach((function(e){return d.add(s(e,F(e)))})),q("Set",d,p,r,e),y=d}else if(o===l.Map){var v=new Map;r.forEach((function(e,r){return v.set(r,s(e,F(e),r))})),q("Map",v,p,r,e),y=v}else if(o===l.Array){var h=p.copy||[];p.copy=h,r.forEach((function(e,r){return h.push(s(e,F(e),r))})),y=p.proxyVal}p.proxyItems=y;var M=null===(c=null===(u=p.rootMeta)||void 0===u?void 0:u.proxyItemsMgr)||void 0===c?void 0:c[o];M&&M.push(y)}}return a}if(Y(a,e),!p){p={rootMeta:null,parentMeta:null,parent:r,parentType:o,selfType:H(a),self:a,key:t,idx:f,keyPath:B(r,f,e),level:R(r,e),proxyVal:new Proxy(a,n),copy:i,modified:!1,proxyItems:null,proxyItemsMgr:null,finishDraft:g,ver:e};var m=z(r,e);m&&(p.parentMeta=m,p.rootMeta=m.rootMeta),K(a,p,e)}return p.proxyVal}return a};return a=s(a,null,t),o===l.Array&&E(t)?a:l[o]?X(r,{parentType:o,op:t,key:t,value:a,metaVer:e,calledBy:"get"},!0):a},set:function(r,t,n){return t===T?r.__proto__[T]=n:(X(r,{key:t,value:n,metaVer:e,calledBy:"set"},!0),z(r,e)),!0},deleteProperty:function(r,t){return X(r,{op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"},!0),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(o){if(r)throw new Error("can not call new Limu().createDraft twice");var i=o;r=!0,C(o)&&(i=L(o,o[j]).self),Y(i,e,!0);var l=z(i,e);if(!l){var f=H(i);(l={rootMeta:null,parent:null,parentMeta:null,parentType:f,selfType:f,self:i,copy:null,modified:!1,key:"",keyPath:[],idx:-1,level:0,proxyVal:null,proxyItems:null,proxyItemsMgr:{Map:[],Set:[],Array:[]},finishDraft:a.finishDraft,ver:e}).rootMeta=l,K(i,l,e)}var u=Proxy.revocable(i,n),c=u.proxy,p=u.revoke;return l.proxyVal=c,t=p,c},finishDraft:function(r){if(e!==r[j])throw new Error("oops, the input draft does not match finishDraft handler");var n=L(r,e);if(!n)throw new Error("oops, rootMeta should not be null!");var a=n.self;if(n.copy&&n.modified){a=n.copy;var o=n.proxyItemsMgr.Map,i=null;o.forEach((function(r){if(r[T]){var t=new Map;i=t,r.forEach((function(r,n){var a=z(r,e);if(a){var o=a.modified?a.copy:a.self;t.set(n,o)}})),r.__parent&&(r.__parent[r.__dataIndex]=t)}})),"Map"===n.parentType&&(a=i||a);var l=n.proxyItemsMgr.Set,f=null;l.forEach((function(r){if(r[T]){var t=Array.from(r);f=t,t.forEach((function(r,n){var a=z(r,e);a&&(t[n]=a.modified?a.copy:a.self)})),r.__parent&&(r.__parent[r.__dataIndex]=new Set(t))}})),"Set"===n.parentType&&(a=f?new Set(f):a);var u=n.proxyItemsMgr.Array,c=[];u.forEach((function(r){if(r[T]){var t=z(r,e);((null==t?void 0:t.copy)||r).forEach((function(r,t){var n=z(r,e);c[t]=n?n.modified?n.copy:n.self:r}))}})),"Array"===n.parentType&&c.length&&(a=c)}return t&&t(),function(e){P[e].forEach((function(r){return delete r[e]}))}(e),a}});return a}var ne=function(){var e=te();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function ae(e){return(new ne).createDraft(e)}function oe(e){var r=L(e,e[j]),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("opps, not an Limu draft!");return t(e)}function ie(e){if("function"!=typeof e)throw new Error("produce callback is not a function");if("AsyncFunction"===(r=e).constructor.name||"function"==typeof r.then)throw new Error("produce callback can not be a promise function");var r}function le(e,r,t){void 0===t&&(t=!0),t&&ie(r);var n=ae(e);return r(n),oe(n)}var fe=C,ue=function(e,r){return r?le(e,r):(ie(e),function(r){return le(r,e,!1)})};e.Limu=ne,e.createDraft=ae,e.finishDraft=oe,e.getDraftMeta=function(e){return L(e,e[j])},e.isDraft=fe,e.produce=ue,Object.defineProperty(e,"__esModule",{value:!0})}));
